{% extends "base.html" %}

{% block title %}{{ 'Editar' if empresa else 'Nova' }} Empresa{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>{{ 'Editar Empresa' if empresa else 'Nova Empresa' }}</h2>
        <a href="{{ url_for('admin.listar_empresas') }}" class="btn btn-outline-secondary btn-sm">← Voltar</a>
    </div>

    <div class="card">
        <div class="card-body">
            <form method="POST" enctype="multipart/form-data">
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="emp_nome_fantasia">Nome Fantasia *</label>
                            <input type="text" class="form-control" id="emp_nome_fantasia" name="emp_nome_fantasia"
                                   value="{{ empresa.emp_nome_fantasia if empresa else '' }}"
                                   oninput="this.value = this.value.toUpperCase()"
                                   required>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="emp_razao_social">Razão Social *</label>
                            <input type="text" class="form-control" id="emp_razao_social" name="emp_razao_social"
                                   value="{{ empresa.emp_razao_social if empresa else '' }}"
                                   oninput="this.value = this.value.toUpperCase()"
                                   required>
                        </div>
                    </div>
                </div>

                <!-- TIPO DE EMPRESA (COMBOX) -->
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="emp_tipo">Tipo de Empresa (Tributos Nível Brasil) *</label>
                            <select class="form-control" id="emp_tipo" name="emp_tipo" required>
                                <option value="">Selecione...</option>
                                <option value="MEI" {% if empresa and empresa.emp_tipo == 'MEI' %}selected{% endif %}>MEI - Microempreendedor Individual</option>
                                <option value="Simples Nacional" {% if empresa and empresa.emp_tipo == 'Simples Nacional' %}selected{% endif %}>Simples Nacional</option>
                                <option value="Lucro Real" {% if empresa and empresa.emp_tipo == 'Lucro Real' %}selected{% endif %}>Lucro Real</option>
                                <option value="Lucro Presumido" {% if empresa and empresa.emp_tipo == 'Lucro Presumido' %}selected{% endif %}>Lucro Presumido</option>
                                <option value="Microempresa" {% if empresa and empresa.emp_tipo == 'Microempresa' %}selected{% endif %}>Microempresa</option>
                                <option value="Empresa de Grande Porte" {% if empresa and empresa.emp_tipo == 'Empresa de Grande Porte' %}selected{% endif %}>Empresa de Grande Porte</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="emp_cnpj">CNPJ *</label>
                            <input type="text" class="form-control" id="emp_cnpj" name="emp_cnpj"
                                   value="{{ empresa.emp_cnpj if empresa else '' }}"
                                   placeholder="00.000.000/0000-00"
                                   maxlength="18"
                                   oninput="this.value = this.value.replace(/[^0-9]/g, '').replace(/(\d{2})(\d{3})(\d{3})(\d{4})(\d{2})/, '$1.$2.$3/$4-$5')"
                                   required>
                        </div>
                    </div>
                </div>

                <!-- CERTIFICADO DIGITAL -->
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="emp_certificado_arquivo">Certificado Digital (Arquivo .pfx/.p12)</label>
                            <input type="file" class="form-control" id="emp_certificado_arquivo" name="emp_certificado_arquivo">
                            {% if empresa and empresa.emp_certificado_path %}
                                <small class="form-text text-muted">Atual: {{ empresa.emp_certificado_path }}</small>
                            {% endif %}
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="emp_certificado_senha">Senha do Certificado</label>
                            <input type="password" class="form-control" id="emp_certificado_senha" name="emp_certificado_senha"
                                   value="{{ empresa.emp_certificado_senha if empresa else '' }}">
                        </div>
                    </div>
                </div>

                <!-- TEMPORIZADOR / LICENÇA -->
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="emp_licenca_tipo">Tipo de Licença</label>
                            <select class="form-control" id="emp_licenca_tipo" name="emp_licenca_tipo">
                                <option value="permanente" {% if empresa and empresa.emp_licenca_tipo == 'permanente' %}selected{% endif %}>Permanente</option>
                                <option value="temporaria" {% if empresa and empresa.emp_licenca_tipo == 'temporaria' %}selected{% endif %}>Temporária</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="emp_licenca_data_fim">Data de Fim da Licença (se temporária)</label>
                            <input type="date" class="form-control" id="emp_licenca_data_fim" name="emp_licenca_data_fim"
                                   value="{{ empresa.emp_licenca_data_fim.strftime('%Y-%m-%d') if empresa and empresa.emp_licenca_data_fim else '' }}">
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-12">
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input" id="emp_licenca_desativar_tempo" name="emp_licenca_desativar_tempo"
                                   {% if empresa and empresa.emp_licenca_desativar_tempo %}checked{% endif %}>
                            <label class="form-check-label" for="emp_licenca_desativar_tempo">
                                Desativar temporizador — usar permanentemente
                            </label>
                        </div>
                    </div>
                </div>

                <!-- DEMAIS CAMPOS (CEP, ENDEREÇO, ETC) -->
                <div class="row">
                    <div class="col-md-3">
                        <div class="form-group">
                            <label for="emp_cep">CEP</label>
                            <input type="text" class="form-control" id="emp_cep" name="emp_cep"
                                   value="{{ empresa.emp_cep if empresa else '' }}"
                                   placeholder="00000-000"
                                   maxlength="9"
                                   oninput="this.value = this.value.replace(/[^0-9]/g, '').replace(/(\d{5})(\d{3})/, '$1-$2')">
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="emp_endereco">Endereço</label>
                            <input type="text" class="form-control" id="emp_endereco" name="emp_endereco"
                                   value="{{ empresa.emp_endereco if empresa else '' }}"
                                   oninput="this.value = this.value.toUpperCase()">
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="form-group">
                            <label for="emp_bairro">Bairro</label>
                            <input type="text" class="form-control" id="emp_bairro" name="emp_bairro"
                                   value="{{ empresa.emp_bairro if empresa else '' }}"
                                   oninput="this.value = this.value.toUpperCase()">
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="emp_cidade">Cidade</label>
                            <input type="text" class="form-control" id="emp_cidade" name="emp_cidade"
                                   value="{{ empresa.emp_cidade if empresa else '' }}"
                                   oninput="this.value = this.value.toUpperCase()">
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="form-group">
                            <label for="emp_uf">UF</label>
                            <input type="text" class="form-control" id="emp_uf" name="emp_uf"
                                   value="{{ empresa.emp_uf if empresa else '' }}"
                                   maxlength="2"
                                   oninput="this.value = this.value.toUpperCase()">
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-group">
                            <label for="emp_telefone">Telefone</label>
                            <input type="text" class="form-control" id="emp_telefone" name="emp_telefone"
                                   value="{{ empresa.emp_telefone if empresa else '' }}"
                                   placeholder="(11) 99999-9999"
                                   maxlength="15">
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label for="emp_email">E-mail</label>
                    <input type="email" class="form-control" id="emp_email" name="emp_email"
                           value="{{ empresa.emp_email if empresa else '' }}">
                </div>

                <!-- AMBIENTES LIBERADOS -->
                <div class="form-group">
                    <label for="ambientes">Ambientes Liberados:</label>
                    <select multiple class="form-control" id="ambientes" name="ambientes[]" size="5">
                        {% for ambiente in todos_ambientes %}
                        {% if empresa and ambiente in empresa.ambientes_permitidos %}
                            <option value="{{ ambiente.amb_id }}" selected>
                                {{ ambiente.amb_nome }}
                            </option>
                        {% else %}
                            <option value="{{ ambiente.amb_id }}">
                                {{ ambiente.amb_nome }}
                            </option>
                        {% endif %}
                        {% endfor %}
                    </select>
                    <small class="form-text text-muted">Segure Ctrl (Windows) ou Cmd (Mac) para selecionar múltiplos ambientes.</small>
                </div>

                <button type="submit" class="btn btn-primary">
                    {{ 'Atualizar Empresa' if empresa else 'Cadastrar Empresa' }}
                </button>
            </form>
        </div>
    </div>
</div>
{% endblock %}