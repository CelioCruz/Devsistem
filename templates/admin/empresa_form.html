{% extends "base.html" %}

{% block title %}{{ 'Editar' if empresa else 'Nova' }} Empresa{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>{{ 'Editar Empresa' if empresa else 'Nova Empresa' }}</h2>
        <a href="{{ url_for('admin.cadastro') }}" class="btn btn-outline-secondary btn-sm">‚Üê Voltar</a>
    </div>

    <div class="card">
        <div class="card-body">
            <!-- ‚ö†Ô∏è enctype obrigat√≥rio para upload de arquivos -->
            <form method="POST" enctype="multipart/form-data">
                <!-- Dados b√°sicos -->
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="emp_nome_fantasia">Nome Fantasia *</label>
                            <input type="text" class="form-control" id="emp_nome_fantasia" name="emp_nome_fantasia"
                                   value="{{ empresa.emp_nome_fantasia if empresa else '' }}"
                                   oninput="this.value = this.value.toUpperCase()"
                                   required>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="emp_razao_social">Raz√£o Social *</label>
                            <input type="text" class="form-control" id="emp_razao_social" name="emp_razao_social"
                                   value="{{ empresa.emp_razao_social if empresa else '' }}"
                                   oninput="this.value = this.value.toUpperCase()"
                                   required>
                        </div>
                    </div>
                </div>

                <!-- CNPJ e Inscri√ß√µes -->
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="emp_cnpj">CNPJ *</label>
                            <input type="text" class="form-control" id="emp_cnpj" name="emp_cnpj"
                                   value="{{ empresa.emp_cnpj if empresa else '' }}"
                                   placeholder="00.000.000/0000-00"
                                   maxlength="18"
                                   oninput="this.value = this.value.replace(/[^0-9]/g, '').replace(/(\d{2})(\d{3})(\d{3})(\d{4})(\d{2})/, '$1.$2.$3/$4-$5')"
                                   required>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="form-group">
                            <label for="emp_ie">Inscri√ß√£o Estadual</label>
                            <input type="text" class="form-control" id="emp_ie" name="emp_ie"
                                   value="{{ empresa.emp_ie if empresa else '' }}">
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="form-group">
                            <label for="emp_im">Inscri√ß√£o Municipal</label>
                            <input type="text" class="form-control" id="emp_im" name="emp_im"
                                   value="{{ empresa.emp_im if empresa else '' }}">
                        </div>
                    </div>
                </div>

                <!-- Endere√ßo -->
                <div class="row">
                    <div class="col-md-3">
                        <div class="form-group">
                            <label for="emp_cep">CEP</label>
                            <input type="text" class="form-control" id="emp_cep" name="emp_cep"
                                   value="{{ empresa.emp_cep if empresa else '' }}"
                                   placeholder="00000-000"
                                   maxlength="9"
                                   oninput="this.value = this.value.replace(/[^0-9]/g, '').replace(/(\d{5})(\d{3})/, '$1-$2')">
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="emp_endereco">Endere√ßo</label>
                            <input type="text" class="form-control" id="emp_endereco" name="emp_endereco"
                                   value="{{ empresa.emp_endereco if empresa else '' }}"
                                   oninput="this.value = this.value.toUpperCase()">
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="form-group">
                            <label for="emp_bairro">Bairro</label>
                            <input type="text" class="form-control" id="emp_bairro" name="emp_bairro"
                                   value="{{ empresa.emp_bairro if empresa else '' }}"
                                   oninput="this.value = this.value.toUpperCase()">
                        </div>
                    </div>
                </div>

                <!-- Cidade, UF, Telefone -->
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="emp_cidade">Cidade</label>
                            <input type="text" class="form-control" id="emp_cidade" name="emp_cidade"
                                   value="{{ empresa.emp_cidade if empresa else '' }}"
                                   oninput="this.value = this.value.toUpperCase()">
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="form-group">
                            <label for="emp_uf">UF</label>
                            <input type="text" class="form-control" id="emp_uf" name="emp_uf"
                                   value="{{ empresa.emp_uf if empresa else '' }}"
                                   maxlength="2"
                                   oninput="this.value = this.value.toUpperCase()">
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-group">
                            <label for="emp_telefone">Telefone</label>
                            <input type="text" class="form-control" id="emp_telefone" name="emp_telefone"
                                   value="{{ empresa.emp_telefone if empresa else '' }}"
                                   placeholder="(11) 99999-9999"
                                   maxlength="15">
                        </div>
                    </div>
                </div>

                <!-- E-mail -->
                <div class="form-group">
                    <label for="emp_email">E-mail</label>
                    <input type="email" class="form-control" id="emp_email" name="emp_email"
                           value="{{ empresa.emp_email if empresa else '' }}">
                </div>

                <!-- üîπ TIPO DE EMPRESA (TRIBUTA√á√ÉO) -->
                <div class="form-group mt-3">
                    <label for="emp_tipo">Tipo Tribut√°rio (N√≠vel Brasil) *</label>
                    <select class="form-control" id="emp_tipo" name="emp_tipo" required>
                        <option value="">Selecione o regime tribut√°rio</option>
                        <option value="MEI" {% if empresa and empresa.emp_tipo == 'MEI' %}selected{% endif %}>MEI - Microempreendedor Individual</option>
                        <option value="Simples Nacional" {% if empresa and empresa.emp_tipo == 'Simples Nacional' %}selected{% endif %}>Simples Nacional</option>
                        <option value="Lucro Real" {% if empresa and empresa.emp_tipo == 'Lucro Real' %}selected{% endif %}>Lucro Real</option>
                        <option value="Lucro Presumido" {% if empresa and empresa.emp_tipo == 'Lucro Presumido' %}selected{% endif %}>Lucro Presumido</option>
                        <option value="Microempresa" {% if empresa and empresa.emp_tipo == 'Microempresa' %}selected{% endif %}>Microempresa</option>
                        <option value="Empresa de Grande Porte" {% if empresa and empresa.emp_tipo == 'Empresa de Grande Porte' %}selected{% endif %}>Empresa de Grande Porte</option>
                    </select>
                </div>

                <!-- üîπ CERTIFICADO DIGITAL -->
                <div class="form-group mt-3">
                    <label>Certificado Digital A1 (.pfx ou .p12)</label>
                    <div class="d-flex align-items-center">
                        <input type="file" class="form-control" id="emp_certificado_arquivo" name="emp_certificado_arquivo"
                               accept=".pfx,.p12">
                        {% if empresa and empresa.emp_certificado_a1 %}
                            <a href="{{ url_for('admin.download_certificado', id=empresa.emp_reg) }}" 
                               class="btn btn-sm btn-outline-info ms-2" title="Baixar certificado atual">
                                <i class="fas fa-download"></i> Baixar
                            </a>
                        {% endif %}
                    </div>
                    {% if empresa and empresa.emp_certificado_a1 %}
                        <small class="form-text text-muted">Certificado j√° cadastrado.</small>
                    {% endif %}
                </div>

                <div class="form-group mt-2">
                    <label for="emp_certificado_senha">Senha do Certificado</label>
                    <!-- ‚ö†Ô∏è NUNCA exibir a senha salva por seguran√ßa -->
                    <input type="password" class="form-control" id="emp_certificado_senha" name="emp_certificado_senha"
                           placeholder="Digite a senha do certificado">
                    <small class="form-text text-muted">A senha ser√° armazenada de forma criptografada.</small>
                </div>

                <!-- üîπ LICEN√áA / TEMPORIZADOR -->
                <div class="form-group mt-4">
                    <label>Tipo de Licen√ßa</label>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="emp_licenca_tipo" id="licenca_permanente" value="permanente"
                               {% if not empresa or empresa.emp_licenca_tipo == 'permanente' %}checked{% endif %}>
                        <label class="form-check-label" for="licenca_permanente">
                            Permanente
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="emp_licenca_tipo" id="licenca_temporaria" value="temporaria"
                               {% if empresa and empresa.emp_licenca_tipo == 'temporaria' %}checked{% endif %}>
                        <label class="form-check-label" for="licenca_temporaria">
                            Tempor√°ria
                        </label>
                    </div>
                </div>

                <div class="row mt-2" id="data_fim_licenca" style="{% if not empresa or empresa.emp_licenca_tipo != 'temporaria' %}display:none;{% endif %}">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="emp_licenca_data_fim">Data de T√©rmino da Licen√ßa</label>
                            <input type="date" class="form-control" id="emp_licenca_data_fim" name="emp_licenca_data_fim"
                                   value="{{ empresa.emp_licenca_data_fim.strftime('%Y-%m-%d') if empresa and empresa.emp_licenca_data_fim else '' }}">
                        </div>
                    </div>
                </div>

                <div class="form-check mt-3">
                    <input class="form-check-input" type="checkbox" id="emp_licenca_desativar_tempo" name="emp_licenca_desativar_tempo"
                           value="true" {% if empresa and empresa.emp_licenca_desativar_tempo %}checked{% endif %}>
                    <label class="form-check-label" for="emp_licenca_desativar_tempo">
                        Desativar temporizador ‚Äî usar permanentemente (ignora data de t√©rmino)
                    </label>
                </div>

                <!-- Ambientes -->
                <div class="form-group mt-4">
                    <label for="ambientes">Ambientes Liberados *</label>
                    <select multiple class="form-control" id="ambientes" name="ambientes[]" size="6" required>
                        {% if todos_ambientes %}
                            {% for ambiente in todos_ambientes %}
                            <option value="{{ ambiente.amb_id }}">{{ ambiente.amb_nome }}</option>
                            {% endfor %}
                        {% else %}
                            <option disabled>Nenhum ambiente dispon√≠vel</option>
                        {% endif %}
                    </select>
                    <small class="form-text text-muted">Segure Ctrl (Windows) ou Cmd (Mac) para selecionar m√∫ltiplos ambientes.</small>
                </div>

<!-- Script para mostrar/ocultar campo de data conforme tipo de licen√ßa -->
<script>
document.addEventListener('DOMContentLoaded', function () {
    const radioTemp = document.getElementById('licenca_temporaria');
    const radioPerm = document.getElementById('licenca_permanente');
    const dataFimDiv = document.getElementById('data_fim_licenca');

    function toggleDataFim() {
        dataFimDiv.style.display = radioTemp.checked ? 'block' : 'none';
    }

    radioTemp.addEventListener('change', toggleDataFim);
    radioPerm.addEventListener('change', toggleDataFim);
});
</script>
{% endblock %}